<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æœºçš„æ¡£æ¡ˆ</title>
    <style>
        :root { --primary: #6366f1; --bg: #f8fafc; --text: #334155; --card-bg: #ffffff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; padding-bottom: 80px; user-select: none; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .header h1 { font-size: 1.2rem; margin: 0; color: #1e293b; font-weight: 800; }
        .header-icons { display: flex; gap: 10px; }
        .icon-btn { background: white; border: 1px solid #e2e8f0; border-radius: 8px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; text-decoration: none; font-size: 1.2rem; }
        
        .search-box { position: relative; margin-bottom: 15px; }
        .search-box input { width: 100%; padding: 12px 15px; padding-left: 40px; border: none; border-radius: 12px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.03); font-size: 0.95rem; outline: none; }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #94a3b8; }

        .controls-scroll { display: flex; overflow-x: auto; gap: 8px; padding-bottom: 5px; margin-bottom: 15px; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .controls-scroll::-webkit-scrollbar { display: none; }
        .btn { padding: 6px 14px; border-radius: 20px; border: none; font-weight: 600; font-size: 0.85rem; white-space: nowrap; cursor: pointer; transition: all 0.2s; background: white; color: #64748b; border: 1px solid #e2e8f0; }
        .btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .btn-action { background: #10b981; color: white; border: none; }
        .btn-manage { background: #f59e0b; color: white; border: none; }
        .btn-delete { background: #ef4444; color: white; border: none; display: none; }
        .btn-import { background: #8b5cf6; color: white; border: none; }

        .gallery { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        @media (min-width: 600px) { .gallery { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); } }
        
        .card { background: var(--card-bg); border-radius: 12px; overflow: hidden; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.03); border: 2px solid transparent; transition: transform 0.1s; }
        .card:active { transform: scale(0.98); }
        .card.selected { border-color: var(--primary); background: #e0e7ff; }
        .card img { width: 100%; height: 150px; object-fit: cover; background: #f1f5f9; display: block; pointer-events: none; }
        .card-body { padding: 10px; pointer-events: none; }
        .card-body * { pointer-events: auto; }
        
        .tag-text { font-size: 0.8rem; color: #475569; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .edit-btn { float: right; color: #cbd5e1; cursor: pointer; font-size: 0.9rem; padding: 5px; }
        .edit-area { display: none; margin-top: 5px; }
        .edit-area input { width: 100%; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 0.8rem; }
        
        .badge { position: absolute; top: 8px; left: 8px; padding: 3px 6px; border-radius: 6px; font-size: 0.7rem; color: white; font-weight: bold; z-index: 2; backdrop-filter: blur(2px); }
        .badge-manual { background: rgba(59, 130, 246, 0.85); }
        .badge-auto { background: rgba(249, 115, 22, 0.85); }

        .pagination { display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 25px; color: #64748b; font-size: 0.9rem; }
        .page-btn { background: white; width: 40px; height: 40px; border-radius: 50%; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; color: var(--text); }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .upload-panel { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 20px; border-radius: 20px 20px 0 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); z-index: 100; transform: translateY(100%); transition: transform 0.3s; }
        .upload-panel.show { transform: translateY(0); }
        
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 99; display: none; justify-content: center; align-items: center; }
        .modal { background: white; padding: 20px; border-radius: 12px; width: 85%; max-width: 320px; max-height: 80vh; overflow-y: auto; }
        .form-row { margin-bottom: 15px; }
        .form-row label { display: block; margin-bottom: 5px; font-size: 0.9rem; color: #64748b; }
        .form-row input { width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 8px; }
        
        .check-overlay { position: absolute; inset: 0; background: rgba(255,255,255,0.4); display: none; z-index: 5; pointer-events: none; }
        .selection-mode .check-overlay { display: block; }
        .check-mark { position: absolute; top: 8px; right: 8px; width: 20px; height: 20px; background: white; border: 2px solid #cbd5e1; border-radius: 50%; z-index: 6; display: none; align-items: center; justify-content: center; font-size: 12px; color: white; pointer-events: none; }
        .selection-mode .check-mark { display: flex; }
        .card.selected .check-mark { background: var(--primary); border-color: var(--primary); }

        .import-zone { border: 2px dashed #cbd5e1; border-radius: 12px; padding: 30px 20px; text-align: center; cursor: pointer; transition: all 0.2s; margin-bottom: 15px; }
        .import-zone:hover { border-color: var(--primary); background: #f8fafc; }
        .import-zone.drag-over { border-color: var(--primary); background: #ede9fe; }
        .progress-bar { width: 100%; height: 4px; background: #e2e8f0; border-radius: 2px; overflow: hidden; margin-top: 10px; display: none; }
        .progress-fill { height: 100%; background: var(--primary); transition: width 0.3s; }
    </style>
</head>
<body>

    <div class="header">
        <h1>ğŸ¤ æœºçš„æ¡£æ¡ˆ</h1>
        <div class="header-icons">
            <div class="icon-btn" onclick="openSettings()">âš™ï¸</div>
            <div class="icon-btn" onclick="openImport()">ğŸ“¤</div>
            <a href="/backup" class="icon-btn">ğŸ“¥</a>
        </div>
    </div>

    <div class="search-box">
        <span class="search-icon">ğŸ”</span>
        <input type="text" id="searchInput" placeholder="æœæ ‡ç­¾ (å¦‚: ææ€ª)..." oninput="handleSearch()">
    </div>

    <div class="controls-scroll">
        <button class="btn active" onclick="setFilter('all', this)">å…¨éƒ¨</button>
        <button class="btn" onclick="setFilter('manual', this)">æˆ‘ä¼ çš„</button>
        <button class="btn" onclick="setFilter('auto', this)">æœºæ¡çš„</button>
        <div style="width: 10px; flex-shrink: 0;"></div>
        <button class="btn btn-action" onclick="toggleUpload()">â• ä¸Šä¼ </button>
        <button class="btn btn-manage" onclick="toggleSelectMode()" id="manageBtn">âœ… ç®¡ç†</button>
        <button class="btn btn-delete" id="batchDelBtn" onclick="deleteBatch()">ğŸ—‘ï¸ åˆ é™¤</button>
    </div>

    <div class="gallery" id="gallery"></div>

    <div class="pagination" id="pagination">
        <button class="page-btn" onclick="changePage(-1)">â®</button>
        <span id="pageInfo">1 / 1</span>
        <button class="page-btn" onclick="changePage(1)">â¯</button>
    </div>

    <!-- ä¸Šä¼ é¢æ¿ -->
    <div class="upload-panel" id="uploadBox">
        <h3 style="margin-top:0">ä¸Šä¼ æ–°å›¾</h3>
        <input type="file" id="fileInput" accept="image/*" multiple style="width:100%; margin-bottom:10px;">
        <input type="text" id="globalTagInput" placeholder="ç»Ÿä¸€æ ‡ç­¾ (é€‰å¡«)" style="width:100%; padding:10px; border:1px solid #e2e8f0; border-radius:8px; margin-bottom:10px; box-sizing: border-box;">
        <button class="btn btn-action" style="width:100%; padding:12px;" onclick="batchUpload()">ğŸš€ å¼€å§‹ä¸Šä¼ </button>
        <div style="text-align:center; margin-top:10px; color:#94a3b8" onclick="toggleUpload()">å…³é—­</div>
        <div id="uploadStatus" style="text-align:center; font-size:12px; margin-top:5px; color:#64748b;"></div>
    </div>

    <!-- å¯¼å…¥å¤‡ä»½å¼¹çª— -->
    <div class="modal-overlay" id="importModal">
        <div class="modal">
            <h3 style="margin-top:0">ğŸ“¤ å¯¼å…¥å¤‡ä»½</h3>
            <div class="import-zone" id="importZone" onclick="document.getElementById('backupFile').click()">
                <div style="font-size: 3rem; margin-bottom: 10px;">ğŸ“¦</div>
                <div style="color: #64748b; font-size: 0.9rem;">ç‚¹å‡»æˆ–æ‹–æ‹½ ZIP æ–‡ä»¶åˆ°è¿™é‡Œ</div>
                <div style="color: #94a3b8; font-size: 0.75rem; margin-top: 5px;">æ”¯æŒå¯¼å…¥ä¹‹å‰å¯¼å‡ºçš„å¤‡ä»½åŒ…</div>
            </div>
            <input type="file" id="backupFile" accept=".zip" style="display: none;" onchange="handleBackupFile(this.files[0])">
            <div class="progress-bar" id="importProgress">
                <div class="progress-fill" id="importProgressFill"></div>
            </div>
            <div id="importStatus" style="text-align:center; font-size:0.85rem; color:#64748b; margin-top:10px;"></div>
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                <button class="btn" onclick="closeImport()">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- è®¾ç½®å¼¹çª— -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <h3 style="margin-top:0">âš™ï¸ æ’ä»¶è®¾ç½®</h3>
            <div class="form-row"><label>å‘å›¾æ¦‚ç‡ (%)</label><input type="number" id="conf_prob"></div>
            <div class="form-row"><label>å†·å´æ—¶é—´ (ç§’)</label><input type="number" id="conf_cooldown"></div>
            <div class="form-row"><label>æ¯å°æ—¶é™é¢</label><input type="number" id="conf_limit"></div>
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                <button class="btn" onclick="closeSettings()">å–æ¶ˆ</button>
                <button class="btn btn-action" onclick="saveSettings()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        const rawData = {{MEME_DATA}}; 
        let appState = { filter: 'all', search: '', page: 1, pageSize: 20, selectionMode: false, selected: new Set(), filteredItems: [] };
        let longPressTimer;

        function init() { processData(); render(); setupDragDrop(); }

        function processData() {
            let items = Object.entries(rawData).reverse();
            if (appState.filter !== 'all') items = items.filter(([_, info]) => (info.source || 'manual') === appState.filter);
            if (appState.search) { const q = appState.search.toLowerCase(); items = items.filter(([_, info]) => (info.tags || "").toLowerCase().includes(q)); }
            appState.filteredItems = items;
            appState.page = 1;
            updatePagination();
        }

        function render() {
            const container = document.getElementById('gallery');
            container.innerHTML = '';
            const start = (appState.page - 1) * appState.pageSize;
            const pageItems = appState.filteredItems.slice(start, start + appState.pageSize);

            pageItems.forEach(([filename, info]) => {
                const tags = info.tags || "æœªåˆ†ç±»";
                const source = info.source || 'manual';
                const isSel = appState.selected.has(filename);
                
                const div = document.createElement('div');
                div.className = `card ${isSel ? 'selected' : ''}`;
                
                div.onclick = () => handleCardClick(filename);
                div.oncontextmenu = (e) => { e.preventDefault(); handleLongPress(filename); };
                div.ontouchstart = (e) => { 
                    longPressTimer = setTimeout(() => handleLongPress(filename), 600); 
                };
                div.ontouchend = () => clearTimeout(longPressTimer);
                div.ontouchmove = () => clearTimeout(longPressTimer);
                
                div.innerHTML = `
                    <div class="badge ${source==='auto'?'badge-auto':'badge-manual'}">${source==='auto'?'AI':'æˆ‘'}</div>
                    <div class="check-overlay"></div>
                    <div class="check-mark">âœ“</div>
                    <img src="/images/${filename}" loading="lazy">
                    <div class="card-body">
                        <div id="disp-${filename}">
                            <div class="tag-text">${tags}</div>
                            <span class="edit-btn" onclick="showEdit('${filename}', event)">âœ</span>
                        </div>
                        <div class="edit-area" id="edit-${filename}" onclick="event.stopPropagation()">
                            <input type="text" value="${tags}" id="input-${filename}" onkeydown="if(event.key==='Enter') saveTag('${filename}')">
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
            updatePagination();
            updateUI();
        }

        function handleLongPress(filename) {
            if(appState.selectionMode) return;
            if(navigator.vibrate) navigator.vibrate(50);
            if(confirm("ğŸ—‘ï¸ ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾å—ï¼Ÿ")) {
                deleteSingle(filename);
            }
        }

        async function deleteSingle(filename) {
            await fetch('/delete', {method:'POST', body:JSON.stringify({filename})});
            delete rawData[filename];
            processData();
            render();
        }

        function handleCardClick(filename) {
            if (appState.selectionMode) {
                if (appState.selected.has(filename)) appState.selected.delete(filename);
                else appState.selected.add(filename);
                render();
                updateUI();
            } else {
                window.open(`/images/${filename}`, '_blank');
            }
        }

        function setFilter(type, btn) {
            appState.filter = type;
            document.querySelectorAll('.controls-scroll .btn').forEach(b => { if(!b.classList.contains('btn-action') && !b.classList.contains('btn-manage') && !b.classList.contains('btn-import')) b.classList.remove('active'); });
            btn.classList.add('active');
            processData(); render();
        }
        function handleSearch() { appState.search = document.getElementById('searchInput').value.trim(); processData(); render(); }
        function changePage(delta) {
            const max = Math.ceil(appState.filteredItems.length / appState.pageSize) || 1;
            const next = appState.page + delta;
            if (next >= 1 && next <= max) { appState.page = next; render(); window.scrollTo({ top: 0, behavior: 'smooth' }); }
        }
        function updatePagination() {
            const max = Math.ceil(appState.filteredItems.length / appState.pageSize) || 1;
            document.getElementById('pageInfo').innerText = `${appState.page} / ${max}`;
            document.getElementById('pagination').style.display = appState.filteredItems.length === 0 ? 'none' : 'flex';
        }
        function toggleSelectMode() {
            appState.selectionMode = !appState.selectionMode;
            document.body.classList.toggle('selection-mode', appState.selectionMode);
            const btn = document.getElementById('manageBtn');
            btn.innerText = appState.selectionMode ? 'å®Œæˆ' : 'âœ… ç®¡ç†';
            btn.style.backgroundColor = appState.selectionMode ? '#64748b' : '#f59e0b';
            if (!appState.selectionMode) appState.selected.clear();
            render(); updateUI();
        }
        function updateUI() {
            const delBtn = document.getElementById('batchDelBtn');
            delBtn.style.display = (appState.selectionMode && appState.selected.size > 0) ? 'inline-block' : 'none';
            delBtn.innerText = `ğŸ—‘ï¸ åˆ  ${appState.selected.size} å¼ `;
        }
        function showEdit(filename, e) {
            e.stopPropagation();
            document.getElementById(`disp-${filename}`).style.display = 'none';
            document.getElementById(`edit-${filename}`).style.display = 'block';
            document.getElementById(`input-${filename}`).focus();
        }
        async function saveTag(filename) {
            const newTags = document.getElementById(`input-${filename}`).value;
            const res = await fetch('/update_tag', { method: 'POST', body: JSON.stringify({filename, tags: newTags}) });
            if(res.ok) { rawData[filename].tags = newTags; document.getElementById(`disp-${filename}`).style.display = 'block'; document.getElementById(`edit-${filename}`).style.display = 'none'; processData(); render(); }
        }
        async function deleteBatch() {
            if(!confirm(`ç¡®å®šåˆ é™¤è¿™ ${appState.selected.size} å¼ å›¾ç‰‡å—ï¼Ÿ`)) return;
            await fetch('/batch_delete', { method: 'POST', body: JSON.stringify({filenames: Array.from(appState.selected)}) });
            appState.selected.forEach(f => delete rawData[f]);
            appState.selected.clear(); toggleSelectMode(); processData(); render();
        }
        async function batchUpload() {
            const files = document.getElementById('fileInput').files;
            const globalTag = document.getElementById('globalTagInput').value.trim();
            const status = document.getElementById('uploadStatus');
            if(files.length === 0) return;
            status.innerText = "ä¸Šä¼ ä¸­...";
            for(let i=0; i<files.length; i++) {
                const fd = new FormData(); fd.append('file', files[i]); fd.append('tags', globalTag || "æœªåˆ†ç±»");
                try { await fetch('/upload', {method: 'POST', body: fd}); } catch(e){}
                status.innerText = `è¿›åº¦: ${i+1}/${files.length}`;
            }
            status.innerText = "ä¸Šä¼ å®Œæˆï¼Œå³å°†åˆ·æ–°"; setTimeout(() => location.reload(), 1000);
        }
        function toggleUpload() { document.getElementById('uploadBox').classList.toggle('show'); }
        async function openSettings() {
            const res = await fetch('/get_config'); const conf = await res.json();
            document.getElementById('conf_prob').value = conf.reply_prob; document.getElementById('conf_cooldown').value = conf.pick_cooldown; document.getElementById('conf_limit').value = conf.max_per_hour;
            document.getElementById('settingsModal').style.display = 'flex';
        }
        function closeSettings() { document.getElementById('settingsModal').style.display = 'none'; }
        async function saveSettings() {
            const conf = { reply_prob: parseInt(document.getElementById('conf_prob').value), pick_cooldown: parseInt(document.getElementById('conf_cooldown').value), max_per_hour: parseInt(document.getElementById('conf_limit').value) };
            await fetch('/update_config', {method:'POST', body:JSON.stringify(conf)}); alert("ä¿å­˜æˆåŠŸ"); closeSettings();
        }

        // ============ å¯¼å…¥å¤‡ä»½åŠŸèƒ½ ============
        function openImport() {
            document.getElementById('importModal').style.display = 'flex';
            document.getElementById('importStatus').innerText = '';
            document.getElementById('importProgress').style.display = 'none';
        }
        function closeImport() {
            document.getElementById('importModal').style.display = 'none';
        }

        function setupDragDrop() {
            const zone = document.getElementById('importZone');
            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('drag-over');
            });
            zone.addEventListener('dragleave', () => {
                zone.classList.remove('drag-over');
            });
            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('drag-over');
                const files = e.dataTransfer.files;
                if(files.length > 0 && files[0].name.endsWith('.zip')) {
                    handleBackupFile(files[0]);
                }
            });
        }

        async function handleBackupFile(file) {
            if(!file || !file.name.endsWith('.zip')) {
                alert('è¯·é€‰æ‹© ZIP æ ¼å¼çš„å¤‡ä»½æ–‡ä»¶');
                return;
            }

            const status = document.getElementById('importStatus');
            const progress = document.getElementById('importProgress');
            const fill = document.getElementById('importProgressFill');
            
            status.innerText = 'æ­£åœ¨è§£æå¤‡ä»½æ–‡ä»¶...';
            progress.style.display = 'block';
            fill.style.width = '10%';

            try {
                const zip = await JSZip.loadAsync(file);
                
                // æ£€æŸ¥å¤‡ä»½æ–‡ä»¶ç»“æ„
                if (!zip.files['memes.json']) {
    throw new Error('æœªæ‰¾åˆ° memes.json');
}

const hasImages = Object.keys(zip.files).some(name =>
    name.startsWith('images/') && !name.endsWith('/')
);

if (!hasImages) {
    throw new Error('æœªæ‰¾åˆ° images ç›®å½•ä¸‹çš„å›¾ç‰‡æ–‡ä»¶');
}

                fill.style.width = '30%';
                status.innerText = 'æ­£åœ¨è¯»å–æ•°æ®...';

                // è¯»å– memes.json
                const memesJson = await zip.files['memes.json'].async('text');
                const memesData = JSON.parse(memesJson);

                fill.style.width = '50%';
                status.innerText = 'æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...';

                // ä¸Šä¼ æ‰€æœ‰å›¾ç‰‡
                const imageFiles = Object.keys(zip.files).filter(name => name.startsWith('images/') && name !== 'images/');
                let uploaded = 0;

                for(const imgPath of imageFiles) {
                    const filename = imgPath.replace('images/', '');
                    const imgBlob = await zip.files[imgPath].async('blob');
                    
                    const fd = new FormData();
                    fd.append('file', imgBlob, filename);
                    fd.append('tags', memesData[filename]?.tags || 'æœªåˆ†ç±»');
                    
                    try {
                        await fetch('/upload', {method: 'POST', body: fd});
                    } catch(e) {
                        console.error('ä¸Šä¼ å¤±è´¥:', filename, e);
                    }

                    uploaded++;
                    const percent = 50 + (uploaded / imageFiles.length * 40);
                    fill.style.width = percent + '%';
                    status.innerText = `æ­£åœ¨ä¸Šä¼ å›¾ç‰‡ ${uploaded}/${imageFiles.length}`;
                }

                fill.style.width = '100%';
                status.innerText = 'âœ… å¯¼å…¥æˆåŠŸï¼å³å°†åˆ·æ–°...';
                status.style.color = '#10b981';

                setTimeout(() => location.reload(), 1500);

            } catch(error) {
                status.innerText = 'âŒ å¯¼å…¥å¤±è´¥: ' + error.message;
                status.style.color = '#ef4444';
                console.error('å¯¼å…¥é”™è¯¯:', error);
            }
        }

        init();
    </script>
</body>
</html>
