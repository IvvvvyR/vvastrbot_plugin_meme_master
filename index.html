<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœºçš„è¡¨æƒ…åŒ…æ¡£æ¡ˆ</title>
    <style>
        :root { --primary: #6366f1; --danger: #ef4444; --bg: #f8fafc; --text: #334155; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); padding: 15px; max-width: 1000px; margin: 0 auto; color: var(--text); }
        h1 { text-align: center; font-size: 1.5rem; margin-bottom: 1rem; color: #1e293b; }
        
        .header-actions { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn { padding: 8px 14px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 0.85rem; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; margin-right: 5px; }
        .btn-backup { background: #8b5cf6; color: white; }
        .btn-del-batch { background: var(--danger); color: white; display: none; }
        
        .controls { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin-bottom: 15px; }
        .filter-btn { background: white; border: 1px solid #cbd5e1; color: #64748b; }
        .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .upload-section { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; display: none; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .upload-section.show { display: block; }
        .btn-upload-big { background: #10b981; color: white; width: 100%; margin-top: 10px; padding: 12px; font-size: 1rem; }

        .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; }
        .card { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative; border: 2px solid transparent; transition: all 0.2s; }
        .card.selected { border-color: var(--primary); transform: scale(0.98); }
        .card img { width: 100%; height: 140px; object-fit: cover; background: #f1f5f9; }
        
        .card-body { padding: 8px; }
        .tag-display { font-size: 12px; color: #475569; display: flex; justify-content: space-between; align-items: center; }
        .edit-icon { cursor: pointer; color: #94a3b8; padding: 5px; }
        .tag-edit-area { display: none; margin-top: 5px; }
        .tag-edit-area input { width: 100%; padding: 4px; font-size: 12px; margin-bottom: 4px; }
        
        .badge { position: absolute; top: 6px; left: 6px; padding: 2px 6px; border-radius: 4px; font-size: 10px; color: white; font-weight: bold; z-index: 2; }
        .badge-manual { background: rgba(59, 130, 246, 0.9); }
        .badge-auto { background: rgba(249, 115, 22, 0.9); }
        
        /* é€‰æ‹©æ¨¡å¼é®ç½© */
        .select-mask { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.3); z-index: 10; display: none; cursor: pointer; }
        .selection-mode .select-mask { display: block; }
        .check-icon { position: absolute; top: 5px; right: 5px; background: var(--primary); color: white; border-radius: 50%; width: 20px; height: 20px; display: none; align-items: center; justify-content: center; font-size: 12px; z-index: 11; }
        .card.selected .check-icon { display: flex; }

        /* æ‰¹é‡ä¸Šä¼ è¿›åº¦æ¡ */
        .progress-bar { height: 4px; background: #e2e8f0; margin-top: 10px; border-radius: 2px; overflow: hidden; display: none; }
        .progress-fill { height: 100%; background: #10b981; width: 0%; transition: width 0.3s; }
    </style>
</head>
<body>
    <div class="header-actions">
        <h1>ğŸ¤ æœºçš„è¡¨æƒ…åŒ…æ¡£æ¡ˆ</h1>
        <div>
            <a href="/backup" class="btn btn-backup">ğŸ“¥ å¤‡ä»½</a>
        </div>
    </div>
    
    <div class="controls">
        <button class="btn filter-btn active" onclick="setFilter('all')">å…¨éƒ¨</button>
        <button class="btn filter-btn" onclick="setFilter('manual')">æˆ‘ä¼ çš„</button>
        <button class="btn filter-btn" onclick="setFilter('auto')">æœºçš„å°åƒåœ¾</button>
        <button class="btn" style="background:#10b981; color:white;" onclick="toggleUpload()">â• ä¸Šä¼ </button>
        <button class="btn" style="background:#f59e0b; color:white;" onclick="toggleSelectMode()" id="manageBtn">âœ… ç®¡ç†</button>
        <button class="btn btn-del-batch" id="batchDelBtn" onclick="deleteBatch()">ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­</button>
    </div>

    <div class="upload-section" id="uploadBox">
        <input type="file" id="fileInput" accept="image/*" multiple style="width:100%; padding:10px; border:2px dashed #cbd5e1; border-radius:8px;">
        <input type="text" id="globalTagInput" placeholder="ç»Ÿä¸€æ ‡ç­¾ (å¦‚: ææ€ª)" style="width:100%; padding:10px; margin-top:10px; border:1px solid #cbd5e1; border-radius:8px; box-sizing:border-box">
        <button class="btn btn-upload-big" onclick="batchUpload()">ğŸš€ å¼€å§‹ä¸Šä¼ </button>
        <div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>
        <p id="uploadStatus" style="text-align:center; font-size:12px; color:#64748b; margin-top:5px;"></p>
    </div>

    <div class="gallery" id="gallery"></div>

    <script>
        const rawData = {{MEME_DATA}}; 
        let currentFilter = 'all';
        let isSelectionMode = false;
        let selectedFiles = new Set();

        function render() {
            const container = document.getElementById('gallery');
            container.innerHTML = '';
            const items = Object.entries(rawData).reverse();

            for (const [filename, info] of items) {
                const tags = info.tags || "æœªåˆ†ç±»"; 
                const source = info.source || 'manual';
                if (currentFilter !== 'all' && source !== currentFilter) continue;

                const isSel = selectedFiles.has(filename);
                const div = document.createElement('div');
                div.className = `card ${isSel ? 'selected' : ''}`;
                div.onclick = (e) => handleCardClick(filename, e);

                div.innerHTML = `
                    <div class="badge ${source==='auto'?'badge-auto':'badge-manual'}">${source==='auto'?'AI':'æˆ‘'}</div>
                    <div class="select-mask"></div>
                    <div class="check-icon">âœ“</div>
                    <a href="/images/${filename}" target="_blank"><img src="/images/${filename}" loading="lazy"></a>
                    <div class="card-body">
                        <div class="tag-display" id="disp-${filename}">
                            <span>ğŸ·ï¸ ${tags}</span>
                            <span class="edit-icon" onclick="showEdit('${filename}', event)">âœï¸</span>
                        </div>
                        <div class="tag-edit-area" id="edit-${filename}" onclick="event.stopPropagation()">
                            <input type="text" value="${tags}" id="input-${filename}">
                            <button class="btn" style="background:#6366f1; color:white; width:100%; padding:4px;" onclick="saveTag('${filename}')">ä¿å­˜</button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            }
            updateBatchBtn();
        }

        function toggleSelectMode() {
            isSelectionMode = !isSelectionMode;
            document.body.classList.toggle('selection-mode', isSelectionMode);
            document.getElementById('manageBtn').innerText = isSelectionMode ? 'âŒ é€€å‡º' : 'âœ… ç®¡ç†';
            selectedFiles.clear();
            render();
        }

        function handleCardClick(filename, event) {
            if(!isSelectionMode) return;
            if(selectedFiles.has(filename)) selectedFiles.delete(filename);
            else selectedFiles.add(filename);
            render();
        }

        async function deleteBatch() {
            if(selectedFiles.size === 0) return;
            if(!confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${selectedFiles.size} å¼ å›¾å—ï¼Ÿ`)) return;
            
            await fetch('/batch_delete', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({filenames: Array.from(selectedFiles)})
            });
            
            for(let f of selectedFiles) delete rawData[f];
            toggleSelectMode(); // é€€å‡ºç®¡ç†æ¨¡å¼
        }

        function updateBatchBtn() {
            const btn = document.getElementById('batchDelBtn');
            if(isSelectionMode && selectedFiles.size > 0) {
                btn.style.display = 'inline-flex';
                btn.innerText = `ğŸ—‘ï¸ åˆ é™¤ (${selectedFiles.size})`;
            } else {
                btn.style.display = 'none';
            }
        }

        // æ ‡ç­¾ä¿®æ”¹
        function showEdit(filename, e) {
            e.stopPropagation(); // é˜²æ­¢è§¦å‘é€‰å›¾
            document.getElementById(`disp-${filename}`).style.display = 'none';
            document.getElementById(`edit-${filename}`).style.display = 'block';
        }

        async function saveTag(filename) {
            const newTags = document.getElementById(`input-${filename}`).value;
            const resp = await fetch('/update_tag', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({filename: filename, tags: newTags})
            });
            if(resp.ok) {
                rawData[filename].tags = newTags;
                render();
            } else alert("ä¿®æ”¹å¤±è´¥");
        }

        // ä¸Šä¼ ä¸è¿‡æ»¤
        async function batchUpload() {
            const files = document.getElementById('fileInput').files;
            const globalTag = document.getElementById('globalTagInput').value.trim() || "æœªåˆ†ç±»";
            const status = document.getElementById('uploadStatus');
            const fill = document.getElementById('progressFill');
            document.getElementById('progressBar').style.display = 'block';

            if(files.length === 0) return alert("è¯·é€‰å›¾ï¼");
            let success = 0;
            for(let i=0; i<files.length; i++) {
                const fd = new FormData();
                fd.append('file', files[i]);
                fd.append('tags', globalTag);
                try {
                    status.innerText = `æ­£åœ¨ä¸Šä¼  ${i+1}/${files.length}`;
                    await fetch('/upload', {method: 'POST', body: fd});
                    success++;
                } catch(e){}
                fill.style.width = `${((i+1)/files.length)*100}%`;
            }
            status.innerText = `âœ… å®Œæˆ ${success} å¼ `;
            setTimeout(() => location.reload(), 1000);
        }

        function setFilter(type) {
            currentFilter = type;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            render();
        }
        function toggleUpload() { document.getElementById('uploadBox').classList.toggle('show'); }
        render();
    </script>
</body>
</html>
