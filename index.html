<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœºçš„è¡¨æƒ…åŒ…æ”¶å½•</title>
    <style>
        :root { --primary: #6366f1; --bg: #f8fafc; --text: #334155; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); padding: 15px; max-width: 1000px; margin: 0 auto; color: var(--text); }
        h1 { text-align: center; font-size: 1.5rem; margin-bottom: 1rem; color: #1e293b; }
        
        .header-actions { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn { padding: 8px 16px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 0.9rem; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; }
        .btn-backup { background: #8b5cf6; color: white; }
        .btn-upload { background: #10b981; color: white; width: 100%; margin-top: 10px; padding: 12px; font-size: 1rem; }
        
        .controls { display: flex; gap: 8px; justify-content: center; overflow-x: auto; padding-bottom: 5px; }
        .filter-btn { background: white; border: 1px solid #cbd5e1; color: #64748b; }
        .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .upload-section { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; display: none; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .upload-section.show { display: block; animation: slideDown 0.3s ease; }
        @keyframes slideDown { from {opacity:0; transform:translateY(-10px);} to {opacity:1; transform:translateY(0);} }

        .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; }
        .card { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative; }
        .card img { width: 100%; height: 140px; object-fit: cover; background: #f1f5f9; }
        .card-body { padding: 8px; }
        
        .tag-display { font-size: 12px; color: #475569; display: flex; justify-content: space-between; align-items: center; }
        .edit-icon { cursor: pointer; color: #94a3b8; padding: 2px 5px; }
        .edit-icon:hover { color: var(--primary); }
        
        .tag-edit-area { display: none; margin-top: 5px; }
        .tag-edit-area input { width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 12px; box-sizing: border-box; }
        .tag-edit-area button { margin-top: 4px; width: 100%; font-size: 10px; background: var(--primary); color: white; border: none; border-radius: 4px; padding: 4px; cursor: pointer; }

        .badge { position: absolute; top: 6px; left: 6px; padding: 2px 6px; border-radius: 4px; font-size: 10px; color: white; font-weight: bold; z-index: 2; }
        .badge-manual { background: rgba(59, 130, 246, 0.9); }
        .badge-auto { background: rgba(249, 115, 22, 0.9); }
        .delete-btn { position: absolute; top: 6px; right: 6px; background: rgba(0,0,0,0.4); color: white; border: none; width: 22px; height: 22px; border-radius: 50%; cursor: pointer; z-index: 2; }
        
        /* æ‰¹é‡ä¸Šä¼ è¿›åº¦æ¡ */
        .progress-bar { height: 4px; background: #e2e8f0; margin-top: 10px; border-radius: 2px; overflow: hidden; display: none; }
        .progress-fill { height: 100%; background: #10b981; width: 0%; transition: width 0.3s; }
    </style>
</head>
<body>
    <div class="header-actions">
        <h1>ğŸ¤ æœºçš„è¡¨æƒ…åŒ…æ”¶å½•</h1>
        <a href="/backup" class="btn btn-backup" target="_blank">ğŸ“¥ å¤‡ä»½</a>
    </div>
    
    <div class="controls">
        <button class="btn filter-btn active" onclick="setFilter('all')">å…¨éƒ¨</button>
        <button class="btn filter-btn" onclick="setFilter('manual')">æˆ‘ä¼ çš„</button>
        <button class="btn filter-btn" onclick="setFilter('auto')">æœºæ¡çš„å°åƒåœ¾ä»¬</button>
        <button class="btn filter-btn" style="background:#10b981; color:white; border-color:#10b981" onclick="toggleUpload()">â• æ‰¹é‡ä¸Šä¼ </button>
    </div>

    <div class="upload-section" id="uploadBox">
        <p style="margin:0 0 10px 0; color:#64748b; font-size:0.9rem">ğŸ’¡ æ‰‹æœºå¯é•¿æŒ‰å›¾ç‰‡è¿›è¡Œå¤šé€‰</p>
        <!-- multiple å±æ€§å…è®¸æ‰¹é‡é€‰æ‹© -->
        <input type="file" id="fileInput" accept="image/*" multiple style="width:100%; padding:10px; border:2px dashed #cbd5e1; border-radius:8px;">
        <input type="text" id="globalTagInput" placeholder="ç»Ÿä¸€æ ‡ç­¾ (é€‰å¡«ï¼Œå¦‚: ææ€ª)" style="width:100%; padding:10px; margin-top:10px; border:1px solid #cbd5e1; border-radius:8px; box-sizing:border-box">
        
        <button class="btn btn-upload" onclick="batchUpload()">ğŸš€ å¼€å§‹ä¸Šä¼ </button>
        <div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>
        <p id="uploadStatus" style="text-align:center; font-size:12px; color:#64748b; margin-top:5px;"></p>
    </div>

    <div class="gallery" id="gallery"></div>

    <script>
        const rawData = {{MEME_DATA}}; 
        let currentFilter = 'all';

        function render() {
            const container = document.getElementById('gallery');
            container.innerHTML = '';
            const items = Object.entries(rawData).reverse();

            for (const [filename, info] of items) {
                const tags = info.tags || "æœªåˆ†ç±»"; 
                const source = info.source || 'manual';
                if (currentFilter !== 'all' && source !== currentFilter) continue;

                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
                    <div class="badge ${source==='auto'?'badge-auto':'badge-manual'}">${source==='auto'?'AI':'æˆ‘'}</div>
                    <button class="delete-btn" onclick="deleteMeme('${filename}')">Ã—</button>
                    <a href="/images/${filename}" target="_blank"><img src="/images/${filename}" loading="lazy"></a>
                    <div class="card-body">
                        <div class="tag-display" id="disp-${filename}">
                            <span>ğŸ·ï¸ ${tags}</span>
                            <span class="edit-icon" onclick="showEdit('${filename}', '${tags}')">âœï¸</span>
                        </div>
                        <div class="tag-edit-area" id="edit-${filename}">
                            <input type="text" value="${tags}" id="input-${filename}">
                            <button onclick="saveTag('${filename}')">ä¿å­˜</button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            }
        }

        // === æ‰¹é‡ä¸Šä¼ é€»è¾‘ ===
        async function batchUpload() {
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;
            const globalTag = document.getElementById('globalTagInput').value.trim() || "æœªåˆ†ç±»";
            const status = document.getElementById('uploadStatus');
            const bar = document.getElementById('progressBar');
            const fill = document.getElementById('progressFill');

            if(files.length === 0) return alert("è¯·è‡³å°‘é€‰ä¸€å¼ å›¾ï¼");

            bar.style.display = 'block';
            let successCount = 0;

            for(let i=0; i<files.length; i++) {
                const fd = new FormData();
                fd.append('file', files[i]);
                fd.append('tags', globalTag); // æ‰€æœ‰å›¾ç”¨åŒä¸€ä¸ªåˆå§‹æ ‡ç­¾

                try {
                    status.innerText = `æ­£åœ¨ä¸Šä¼  ${i+1}/${files.length}...`;
                    await fetch('/upload', {method: 'POST', body: fd});
                    successCount++;
                } catch(e) {
                    console.error(e);
                }
                fill.style.width = `${((i+1)/files.length)*100}%`;
            }

            status.innerText = `âœ… å®Œæˆï¼æˆåŠŸä¸Šä¼  ${successCount} å¼ ã€‚`;
            setTimeout(() => location.reload(), 1000);
        }

        // === ä¿®æ”¹æ ‡ç­¾é€»è¾‘ ===
        function showEdit(filename, oldTags) {
            document.getElementById(`disp-${filename}`).style.display = 'none';
            document.getElementById(`edit-${filename}`).style.display = 'block';
        }

        async function saveTag(filename) {
            const newTags = document.getElementById(`input-${filename}`).value;
            const resp = await fetch('/update_tag', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({filename: filename, tags: newTags})
            });
            if(resp.ok) {
                // æ›´æ–°æœ¬åœ°æ•°æ®å¹¶é‡ç»˜ï¼Œä¸ç”¨åˆ·æ–°é¡µé¢
                rawData[filename].tags = newTags;
                render();
            } else {
                alert("ä¿®æ”¹å¤±è´¥");
            }
        }

        function setFilter(type) {
            currentFilter = type;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            render();
        }
        function toggleUpload() { document.getElementById('uploadBox').classList.toggle('show'); }
        async function deleteMeme(f) {
            if(confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) {
                await fetch('/delete', {method:'POST', body:JSON.stringify({filename:f})});
                delete rawData[f]; render();
            }
        }
        render();
    </script>
</body>
</html>
