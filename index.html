<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡¨æƒ…åŒ…ç®¡ç†</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f5; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn { padding: 8px 15px; border-radius: 6px; border: none; cursor: pointer; text-decoration: none; font-size: 14px; background: white; border: 1px solid #ddd; }
        .btn-primary { background: #3b82f6; color: white; border: none; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
        .card { background: white; padding: 5px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .card img { width: 100%; height: 120px; object-fit: cover; border-radius: 4px; }
        .tag { font-size: 12px; color: #666; margin-top: 5px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .del-btn { color: red; font-size: 12px; cursor: pointer; float: right; }
    </style>
</head>
<body>
    <div class="header">
        <h2>ğŸ“‚ è¡¨æƒ…åŒ…ç®¡ç†</h2>
        <div>
            <a href="/backup" class="btn">ğŸ“¥ å¤‡ä»½</a>
            <button class="btn btn-primary" onclick="document.getElementById('restoreInput').click()">ğŸ“¤ å¯¼å…¥å¤‡ä»½</button>
            <input type="file" id="restoreInput" hidden accept=".zip" onchange="restoreBackup()">
        </div>
    </div>

    <div class="grid" id="gallery"></div>

    <script>
        const rawData = {{MEME_DATA}};
        
        function render() {
            const container = document.getElementById("gallery");
            container.innerHTML = "";
            Object.entries(rawData).reverse().forEach(([fname, info]) => {
                const div = document.createElement("div");
                div.className = "card";
                div.innerHTML = \`
                    <img src="/images/\${fname}" loading="lazy" onclick="window.open('/images/\${fname}')">
                    <div class="tag">
                        \${info.tags || "æ— "}
                        <span class="del-btn" onclick="del('\${fname}')">åˆ </span>
                    </div>
                \`;
                container.appendChild(div);
            });
        }

        async def(fname) {
            if(!confirm("ç¡®å®šåˆ é™¤å—ï¼Ÿ")) return;
            await fetch("/delete", {method: "POST", body: JSON.stringify({filename: fname})});
            delete rawData[fname];
            render();
        }
        
        // æ ¸å¿ƒï¼šä¸Šä¼ å¤‡ä»½åŠŸèƒ½
        async function restoreBackup() {
            const file = document.getElementById("restoreInput").files[0];
            if(!file) return;
            if(!confirm("âš ï¸ è­¦å‘Šï¼šå¯¼å…¥å¤‡ä»½å°†è¦†ç›–å½“å‰çš„å›¾ç‰‡åº“ï¼Œç¡®å®šå—ï¼Ÿ")) return;
            
            const fd = new FormData();
            fd.append("file", file);
            
            alert("æ­£åœ¨ä¸Šä¼ å¹¶è§£å‹ï¼Œè¯·ç¨å€™...");
            try {
                const res = await fetch("/restore", {method: "POST", body: fd});
                if(res.ok) {
                    alert("âœ… å¯¼å…¥æˆåŠŸï¼é¡µé¢å°†åˆ·æ–°ã€‚");
                    location.reload();
                } else {
                    alert("âŒ å¯¼å…¥å¤±è´¥");
                }
            } catch(e) {
                alert("âŒ ä¸Šä¼ å‡ºé”™: " + e);
            }
        }

        render();
    </script>
</body>
</html>
